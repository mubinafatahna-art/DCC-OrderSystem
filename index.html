<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCC - Customer Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --neon: #00d2ff; --bg: #0f172a; --card: #1e293b; }
        body { background: var(--bg); color: #f8fafc; font-family: sans-serif; }
        .card { background: var(--card); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; }
        .text-neon { color: var(--neon); }
        .form-label { color: var(--neon); font-weight: bold; }
        .form-control, .form-select { background: #334155; border: none; color: white; }
        .form-control:focus { background: #475569; color: white; box-shadow: 0 0 8px var(--neon); }
        .btn-neon { background: linear-gradient(45deg, #00d2ff, #3a7bd5); border: none; color: white; font-weight: bold; }
    </style>
</head>
<body class="p-3">

<div id="loginArea" class="container mt-5" style="display:none;">
    <div class="card p-4 mx-auto shadow" style="max-width: 400px;">
        <h3 class="text-center text-neon fw-bold mb-4">DCC LOGIN</h3>
        <label class="form-label">Nomor WhatsApp</label>
        <input type="text" id="waLogin" class="form-control mb-3 text-center" placeholder="628xxxxxxxx">
        <button onclick="login()" class="btn btn-neon w-100 py-2">MASUK</button>
    </div>
</div>

<div id="dashboardArea" class="container mt-3" style="display:none;">
    <div class="d-flex justify-content-between mb-4">
        <h4 class="text-neon fw-bold">DCC PORTAL</h4>
        <button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card p-4">
                <h5 class="text-neon mb-3 border-bottom pb-2">BUAT PESANAN</h5>
                <form id="formOrder">
                    <label class="form-label">Nama</label>
                    <input type="text" id="nama" class="form-control mb-2" required>
                    
                    <label class="form-label">Kategori</label>
                    <select id="kategori" class="form-select mb-2" onchange="hitung()" required>
                        <option value="Office" data-harga="3500000">Office</option>
                        <option value="Gaming" data-harga="10500000">Gaming</option>
                    </select>

                    <label class="form-label">Metode Bayar</label>
                    <select id="metode" class="form-select mb-2">
                        <option value="Transfer">Transfer BCA: 1234567 (DCC)</option>
                        <option value="Cash">Tunai di Toko</option>
                    </select>

                    <label class="form-label">Spesifikasi Request</label>
                    <textarea id="spek" class="form-control mb-3" rows="3"></textarea>
                    
                    <div class="p-2 text-center rounded mb-3" style="background:rgba(0,210,255,0.1)">
                        <small>Estimasi:</small><h4 id="displayHarga" class="text-neon m-0">Rp 0</h4>
                    </div>
                    <button type="submit" id="btnSimpan" class="btn btn-neon w-100 py-2">KIRIM PESANAN</button>
                </form>
            </div>
        </div>
        <div class="col-lg-7">
            <h5 class="text-white mb-3">TRACKING PESANAN</h5>
            <div id="listPesanan"></div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwA9nMFCqmnwS8epoTZjtNEr5s7qwtcoB93mI4AzUDCr6bCWl_wOb5rFVq5tmDeNL8/exec";
    let currentUserWA = "6281944602761";

    // CEK SESSION SAAT REFRESH
    window.onload = function() {
        const saved = localStorage.getItem('dcc_wa');
        if(saved) { currentUserWA = saved; showDashboard(); }
        else { document.getElementById('loginArea').style.display = 'block'; }
    };

    function login() {
        const wa = document.getElementById('waLogin').value;
        if(!wa) return alert("Isi No WA!");
        localStorage.setItem('dcc_wa', wa);
        currentUserWA = wa;
        showDashboard();
    }

    function logout() { localStorage.removeItem('dcc_wa'); location.reload(); }
    function showDashboard() { 
        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('dashboardArea').style.display = 'block';
        loadOrders(); 
    }

    function hitung() {
        const sel = document.getElementById('kategori');
        const hrg = sel.options[sel.selectedIndex].getAttribute('data-harga');
        document.getElementById('displayHarga').innerText = "Rp " + Number(hrg).toLocaleString('id-ID');
    }

    document.getElementById('formOrder').onsubmit = function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSimpan');
        btn.disabled = true; btn.innerText = "MENGIRIM...";
        
        const payload = {
            action: "tambahPesanan",
            wa: currentUserWA,
            nama: document.getElementById('nama').value,
            kategori: document.getElementById('kategori').value,
            metode: document.getElementById('metode').value,
            spek: document.getElementById('spek').value,
            harga: document.getElementById('displayHarga').innerText
        };

        fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
        .then(() => { alert("Sukses!"); location.reload(); });
    };

    function loadOrders() {
        fetch(`${SCRIPT_URL}?wa=${currentUserWA}`).then(r => r.json()).then(data => {
            let html = "";
            for(let i=data.length-1; i>=1; i--) {
                const status = data[i][8];
                html += `
                <div class="card p-3 mb-2">
                    <div class="d-flex justify-content-between">
                        <small class="text-neon">${data[i][1]}</small>
                        <span class="badge bg-primary">${status}</span>
                    </div>
                    <p class="text-white mb-1 fw-bold">${data[i][4]} (${data[i][7]})</p>
                    <small class="text-white opacity-50">${data[i][11] !== '-' ? 'Info: '+data[i][11] : ''}</small>
                    <div class="mt-2">
                        ${status === 'Pemesanan Diterima' ? `<input type="file" id="f-${data[i][1]}" class="form-control form-control-sm mb-1"><button onclick="upload('${data[i][1]}')" class="btn btn-sm btn-danger w-100">Upload Bukti</button>` : ''}
                    </div>
                </div>`;
            }
            document.getElementById('listPesanan').innerHTML = html;
        });
    }

    async function upload(id) {
        const file = document.getElementById(`f-${id}`).files[0];
        if(!file) return alert("Pilih foto!");
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "uploadBukti", idPesanan: id, file: reader.result }) })
            .then(() => { alert("Berhasil!"); loadOrders(); });
        };
    }
</script>
</body>
</html>
